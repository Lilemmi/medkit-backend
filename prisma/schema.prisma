generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int       @id @default(autoincrement())
  name      String
  email     String    @unique
  password  String
  phone     String?
  allergies String?
  photoUri  String?
  
  // Основная информация
  birthDate DateTime? // Дата рождения
  gender    String?  // Пол: "male", "female", "other"
  
  // Медицинская информация
  weight    Float?   // Вес в кг
  height    Float?   // Рост в см
  chronicDiseases Json? // Хронические заболевания (массив строк)
  medicalConditions Json? // Особые состояния: беременность, диабет, астма и т.д. (массив строк)
  organConditions Json? // Состояния органов, влияющие на дозы: печень, почки и т.д. (массив строк)
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  medicines Medicine[]
  inventoryHistory InventoryHistory[]
  
  @@index([email])
}

model Medicine {
  id        Int      @id @default(autoincrement())
  name      String?
  dose      String?
  form      String?
  expiry    DateTime?
  photoUri  String?
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  inventoryHistory InventoryHistory[]
  
  // Параметры приема лекарства
  takeWithFood          String?  // до еды, после еды, во время еды, независимо
  takeWithLiquid        String?  // чем запивать (вода, молоко и т.д.)
  incompatibleMedicines Json?    // JSON массив названий несовместимых препаратов
  compatibleMedicines   Json?    // JSON массив с информацией о совместимых препаратах
  forbiddenFoods        Json?    // JSON массив запрещенных продуктов
  recommendedFoods      Json?    // JSON массив рекомендуемых продуктов
  alcoholInteraction    String?  // взаимодействие с алкоголем
  caffeineInteraction   String?  // взаимодействие с кофе/чаем
  storageConditions     String?  // условия хранения
  specialInstructions   String?  // особые указания
  sideEffects           String?  // побочные эффекты
  contraindications     String?  // противопоказания
  
  // Количество и учет
  quantity          Int?     // количество упаковок
  totalPills        Int?     // общее количество таблеток в упаковке
  usedPills         Int?     // использовано таблеток
  pillsPerDose      Int?     // количество таблеток на один прием (по умолчанию 1)
  lowStockThreshold Int?     // порог для уведомления о низком количестве (по умолчанию 10)
  familyMemberId    Int?     // ID члена семьи, для кого предназначено лекарство (null = для пользователя)
  userDosage        String?  // дозировка для конкретного пользователя/члена семьи
  
  // Расширенная информация о лекарстве
  internationalName         String?  // Международное непатентованное название (МНН)
  manufacturer              String?  // Производитель
  packageVolume             String?  // Объём / количество в упаковке
  category                  String?  // Категория лекарства
  activeIngredients         Json?    // JSON массив активных веществ
  indications              Json?    // JSON показания к применению
  contraindicationsDetailed Json?   // JSON детальные противопоказания
  warnings                  Json?    // JSON предупреждения и риски
  foodCompatibility         Json?    // JSON совместимость с едой
  drugCompatibility         Json?    // JSON совместимость с другими препаратами
  dosageDetailed            Json?    // JSON детальная дозировка
  childrenRestrictions      Json?    // JSON ограничения для детей
  sideEffectsDetailed       Json?    // JSON детальные побочные эффекты
  storageConditionsDetailed Json?   // JSON детальные условия хранения
  additionalRecommendations Json?   // JSON дополнительные рекомендации
  specialGroupsInfo          Json?    // JSON информация для специальных групп (беременные, кормящие, дети, пожилые, хронические болезни)
  analogs                    Json?    // JSON аналоги и заменители препарата
  
  @@index([userId])
  @@index([expiry])
}

model InventoryHistory {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  medicineId Int?
  medicine  Medicine? @relation(fields: [medicineId], references: [id], onDelete: SetNull)
  action    String   // 'created', 'updated', 'deleted', 'expired', 'expiring_soon'
  oldData   Json?    // Старые данные (для обновлений)
  newData   Json?    // Новые данные
  description String? // Описание действия
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([medicineId])
  @@index([createdAt])
  @@index([action])
}